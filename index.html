<!DOCTYPE html>
<html>
  <head>
    <title>Patient Data Collection App</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      .container {
        max-width: 600px;
        margin: 50px auto;
      }

      #handwritingCanvas {
        border: 1px solid #000;
        touch-action: none;
      }

      #accelerometerTable {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Patient Data Collection App</h1>
      <form id="dataForm">
        <div class="form-group">
          <label for="name">Patient Name:</label>
          <input type="text" class="form-control" id="name" required />
        </div>
        <div class="form-group">
          <label for="voiceRecording">Voice Recording:</label>
          <button type="button" class="btn btn-primary" id="startRecording">
            Start
          </button>
          <button
            type="button"
            class="btn btn-danger"
            id="stopRecording"
            disabled
          >
            Stop
          </button>
          <div id="recordingVisual"></div>
        </div>
        <div class="form-group">
          <label for="handwriting">Handwriting Spiral:</label>
          <canvas id="handwritingCanvas"></canvas>
          <button type="button" class="btn btn-primary" id="clearCanvas">
            Clear
          </button>
        </div>
        <div class="form-group">
          <label for="accelerometerData">Accelerometer Data:</label>
          <table id="accelerometerTable" class="table">
            <thead>
              <tr>
                <th scope="col">Timestamp</th>
                <th scope="col">Acceleration X</th>
                <th scope="col">Acceleration Y</th>
                <th scope="col">Acceleration Z</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <button type="submit" class="btn btn-success">Submit</button>
      </form>
    </div>

    <script>
      // Voice Recording
      let recorder;
      let chunks = [];
      let recordingVisualInterval;

      function startRecording() {
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then(function (stream) {
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = function (e) {
              chunks.push(e.data);
            };
            recorder.start();
            document.getElementById("startRecording").disabled = true;
            document.getElementById("stopRecording").disabled = false;
            document.getElementById("recordingVisual").innerHTML =
              "Recording in progress...";
            recordingVisualInterval = setInterval(function () {
              document.getElementById("recordingVisual").innerHTML += ".";
            }, 1000);
          })
          .catch(function (err) {
            console.log("Error: " + err);
          });
      }

      function stopRecording() {
        recorder.stop();
        document.getElementById("startRecording").disabled = false;
        document.getElementById("stopRecording").disabled = true;
        clearInterval(recordingVisualInterval);
        document.getElementById("recordingVisual").innerHTML = "";
      }

      document
        .getElementById("startRecording")
        .addEventListener("click", startRecording);
      document
        .getElementById("stopRecording")
        .addEventListener("click", stopRecording);

      // Handwriting Spiral
      const canvas = document.getElementById("handwritingCanvas");
      const ctx = canvas.getContext("2d");
      let isDrawing = false;

      function startDrawing(e) {
        isDrawing = true;
        ctx.beginPath();
        ctx.moveTo(getX(e), getY(e));
      }

      function draw(e) {
        if (!isDrawing) return;
        ctx.lineTo(getX(e), getY(e));
        ctx.stroke();
      }

      function stopDrawing() {
        isDrawing = false;
      }

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      function getX(e) {
        if (e.type === "touchmove" || e.type === "touchend") {
          return e.touches[0].clientX - canvas.offsetLeft;
        } else {
          return e.clientX - canvas.offsetLeft;
        }
      }

      function getY(e) {
        if (e.type === "touchmove" || e.type === "touchend") {
          return e.touches[0].clientY - canvas.offsetTop;
        } else {
          return e.clientY - canvas.offsetTop;
        }
      }

      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stopDrawing);
      canvas.addEventListener("touchstart", startDrawing);
      canvas.addEventListener("touchmove", draw);
      canvas.addEventListener("touchend", stopDrawing);
      document
        .getElementById("clearCanvas")
        .addEventListener("click", clearCanvas);

      // Accelerometer Data
      const accelerometerData = [];

      function handleAccelerometerData(e) {
        const acceleration = e.accelerationIncludingGravity;
        const timestamp = new Date().toISOString();
        accelerometerData.push({
          timestamp: timestamp,
          accelerationX: acceleration.x,
          accelerationY: acceleration.y,
          accelerationZ: acceleration.z,
        });
        document
          .getElementById("accelerometerTable")
          .getElementsByTagName("tbody")[0].innerHTML += `
        <tr>
          <td>${timestamp}</td>
          <td>${acceleration.x}</td>
          <td>${acceleration.y}</td>
          <td>${acceleration.z}</td>
        </tr>
      `;
      }

      function exportAccelerometerData() {
        const csv = accelerometerData
          .map((row) => Object.values(row).join(","))
          .join("\n");
        const csvData =
          "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
        const link = document.createElement("a");
        link.setAttribute("href", csvData);
        link.setAttribute("download", "accelerometer_data.csv");
        link.click();
      }

      window.addEventListener("devicemotion", handleAccelerometerData);
      document
        .getElementById("dataForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          exportAccelerometerData();
          // You can include additional logic here to handle form submission and save other data as needed
        });
    </script>
  </body>
</html>

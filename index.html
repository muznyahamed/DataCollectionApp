<!DOCTYPE html>
<html>
<head>
  <title>Patient Data Collection App</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    .section {
      margin-bottom: 20px;
    }

    #handwritingCanvas {
      border: 1px solid #000;
      touch-action: none;
    }

    #visualPlot {
      margin-top: 20px;
      width: 100%;
      height: 100px;
      border: 1px solid #000;
      overflow: hidden;
      position: relative;
    }

    #visualPlot .bar {
      position: absolute;
      bottom: 0;
      width: 1px;
      background-color: purple;
      transition: width 0.1s ease-in-out;
    }

    #downloadButton {
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">Patient Data Collection App</h1>
    <div class="section">
      <h2>Voice Recording</h2>
      <div class="text-center">
        <button type="button" class="btn btn-primary" id="startRecording">Start</button>
        <button type="button" class="btn btn-danger" id="stopRecording" disabled>Stop</button>
      </div>
      <div id="visualPlot"></div>
      <a href="#" id="downloadButton" class="btn btn-success btn-block" download>Download Voice Note</a>
    </div>
    <div class="section">
      <h2>Handwriting Spiral</h2>
      <div class="text-center">
        <canvas id="handwritingCanvas"></canvas>
        <button type="button" class="btn btn-primary mt-2" id="clearCanvas">Clear</button>
        <button type="button" class="btn btn-success mt-2" id="downloadCanvas">Download</button>
      </div>
    </div>
    <div class="section">
      <h2>Accelerometer Data</h2>
      <div id="accelerometerData" class="text-center"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/4.0.1/wavesurfer.min.js"></script>
  <script>
    // Voice Recording
    let recorder;
    const visualPlot = document.getElementById('visualPlot');
    const downloadButton = document.getElementById('downloadButton');
    const sampleRate = 100; // milliseconds
    const recordingDuration = 30000; // 30 seconds

    function startRecording() {
      document.getElementById('startRecording').disabled = true;
      document.getElementById('stopRecording').disabled = false;

      visualPlot.innerHTML = '';
      downloadButton.style.display = 'none';

      const barWidth = Math.floor(visualPlot.clientWidth / (recordingDuration / sampleRate));
      let width = visualPlot.clientWidth;
      let startTime = Date.now();
      const visualizerInterval = setInterval(function() {
        const elapsedTime = Date.now() - startTime;
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.width = barWidth + 'px';
        visualPlot.appendChild(bar);
        width -= barWidth;
        visualPlot.scrollLeft = width;
        if (elapsedTime >= recordingDuration) {
          clearInterval(visualizerInterval);
          document.getElementById('startRecording').disabled = false;
          document.getElementById('stopRecording').disabled = true;
          stopRecording();
        }
      }, sampleRate);

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(function(stream) {
          recorder = new MediaRecorder(stream);
          const chunks = [];
          recorder.ondataavailable = function(e) {
            chunks.push(e.data);
          };
          recorder.onstop = function() {
            const blob = new Blob(chunks, { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            downloadButton.href = url;
            downloadButton.style.display = 'block';
            stream.getTracks().forEach(track => track.stop());
          };
          recorder.start();
        })
        .catch(function(err) {
          console.log('Error: ' + err);
        });
    }

    function stopRecording() {
      recorder.stop();
    }

    document.getElementById('startRecording').addEventListener('click', startRecording);
    document.getElementById('stopRecording').addEventListener('click', stopRecording);

    // Handwriting Spiral
    const canvas = document.getElementById('handwritingCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    function startDrawing(e) {
      isDrawing = true;
      ctx.beginPath();
      ctx.moveTo(getX(e), getY(e));
    }

    function draw(e) {
      if (!isDrawing) return;
      ctx.lineTo(getX(e), getY(e));
      ctx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function getX(e) {
      if (e.type === 'touchmove' || e.type === 'touchend') {
        return e.touches[0].clientX - canvas.offsetLeft;
      } else {
        return e.clientX - canvas.offsetLeft;
      }
    }

    function getY(e) {
      if (e.type === 'touchmove' || e.type === 'touchend') {
        return e.touches[0].clientY - canvas.offsetTop;
      } else {
        return e.clientY - canvas.offsetTop;
      }
    }

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);
    document.getElementById('clearCanvas').addEventListener('click', clearCanvas);
    document.getElementById('downloadCanvas').addEventListener('click', function() {
      const image = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = image;
      a.download = 'handwriting.png';
      a.click();
    });

    // Accelerometer Data
    const accelerometerData = [];

    function handleAccelerometerData(e) {
      const acceleration = e.accelerationIncludingGravity;
      const timestamp = new Date().toISOString();
      accelerometerData.push({
        timestamp: timestamp,
        accelerationX: acceleration.x,
        accelerationY: acceleration.y,
        accelerationZ: acceleration.z
      });
      document.getElementById('accelerometerData').innerHTML = `
        <p>Acceleration X: ${acceleration.x}</p>
        <p>Acceleration Y: ${acceleration.y}</p>
        <p>Acceleration Z: ${acceleration.z}</p>
      `;
    }

    window.addEventListener('devicemotion', handleAccelerometerData);
  </script>
</body>
</html>

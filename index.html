<!DOCTYPE html>
<html>
<head>
  <title>Patient Data Collection App</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    .section {
      margin-bottom: 20px;
    }

    #handwritingCanvas {
      border: 1px solid #000;
      touch-action: none;
    }

    #waveform {
      margin-top: 20px;
      width: 100%;
      height: 100px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">Patient Data Collection App</h1>
    <div class="section">
      <h2>Voice Recording</h2>
      <div class="text-center">
        <button type="button" class="btn btn-primary" id="startRecording">Start</button>
        <button type="button" class="btn btn-danger" id="stopRecording" disabled>Stop</button>
      </div>
      <div id="waveform"></div>
      <div id="timer" class="text-center"></div>
    </div>
    <div class="section">
      <h2>Handwriting Spiral</h2>
      <div class="text-center">
        <canvas id="handwritingCanvas"></canvas>
        <button type="button" class="btn btn-primary mt-2" id="clearCanvas">Clear</button>
        <button type="button" class="btn btn-success mt-2" id="downloadCanvas">Download</button>
      </div>
    </div>
    <div class="section">
      <h2>Accelerometer Data</h2>
      <div id="accelerometerData" class="text-center"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/4.0.1/wavesurfer.min.js"></script>
  <script>
    // Voice Recording
    let recorder;
    let countdownInterval;
    let countdownTime = 30; // 30 seconds
    const visualizerWidth = 300;
    const visualizerHeight = 100;
    const waveform = WaveSurfer.create({
      container: '#waveform',
      waveColor: 'violet',
      progressColor: 'purple',
      height: 100,
      responsive: true
    });

    function updateTimer() {
      document.getElementById('timer').textContent = `Time Remaining: ${countdownTime} seconds`;
    }

    function drawVisualizer() {
      const canvas = document.getElementById('waveform');
      const ctx = canvas.getContext('2d');
      const barWidth = Math.ceil(canvas.width / visualizerWidth);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < visualizerBars.length; i++) {
        const x = i * barWidth;
        const height = (canvas.height * visualizerBars[i]) / visualizerHeight;
        ctx.fillStyle = 'violet';
        ctx.fillRect(x, canvas.height - height, barWidth, height);
      }
    }

    function startRecording() {
      document.getElementById('startRecording').disabled = true;
      document.getElementById('stopRecording').disabled = false;
      countdownTime = 30;
      updateTimer();
      countdownInterval = setInterval(function() {
        countdownTime--;
        if (countdownTime <= 0) {
          clearInterval(countdownInterval);
          document.getElementById('startRecording').disabled = false;
          document.getElementById('stopRecording').disabled = true;
          stopRecording();
          document.getElementById('downloadButton').style.display = 'block';
          return;
        }
        updateTimer();
      }, 1000);

      visualizerBars = [];
      const visualizerInterval = setInterval(function() {
        const visualizerBar = Math.floor(Math.random() * visualizerHeight);
        visualizerBars.push(visualizerBar);
        drawVisualizer();
        if (visualizerBars.length >= visualizerWidth) {
          clearInterval(visualizerInterval);
        }
      }, 30);

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(function(stream) {
          recorder = new MediaRecorder(stream);
          const chunks = [];
          recorder.ondataavailable = function(e) {
            chunks.push(e.data);
          };
          recorder.onstop = function() {
            const blob = new Blob(chunks, { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            waveform.load(url);
          };
          recorder.start();
        })
        .catch(function(err) {
          console.log('Error: ' + err);
        });
    }

    function stopRecording() {
      clearInterval(countdownInterval);
      recorder.stop();
    }

    document.getElementById('startRecording').addEventListener('click', startRecording);
    document.getElementById('stopRecording').addEventListener('click', stopRecording);

    // Rest of the code remains the same...
  </script>
</body>
</html>
